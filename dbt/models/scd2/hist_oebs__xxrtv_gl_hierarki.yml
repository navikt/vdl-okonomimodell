unit_tests:
  - name: hist_oebs__xxrtv_gl_hierarki__full_refresh_changes
    model: hist_oebs__xxrtv_gl_hierarki
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source("oebs", "segmet_hierarki__test")
        rows:
          - {
              hierarchy_code: "A",
              flex_value: "foo",
              flex_value_parent: "bar",
              _oppdatert_tidspunkt: "2020-01-01 00:00:00",
            }
          - {
              hierarchy_code: "A",
              flex_value: "foo",
              flex_value_parent: "baz",
              _oppdatert_tidspunkt: "2020-01-02 00:00:00",
            }
    expect:
      rows:
        - {
            hierarchy_code: "A",
            flex_value: "foo",
            flex_value_parent: "bar",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: "2020-01-02 00:00:00",
          }
        - {
            hierarchy_code: "A",
            flex_value: "foo",
            flex_value_parent: "baz",
            _hist_valid_from: "2020-01-02 00:00:00",
            _hist_valid_to: null,
          }

  - name: hist_oebs__xxrtv_gl_hierarki__full_refresh_no_changes
    model: hist_oebs__xxrtv_gl_hierarki
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source("oebs", "segmet_hierarki__test")
        rows:
          - {
              flex_value: "foo",
              _oppdatert_tidspunkt: "2020-01-01 00:00:00",
            }
          - {
              flex_value: "foo",
              _oppdatert_tidspunkt: "2020-01-02 00:00:00",
            }
    expect:
      rows:
        - {
            flex_value: "foo",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null,
          }

  - name: hist_oebs__xxrtv_gl_hierarki__full_refresh_deleted
    model: hist_oebs__xxrtv_gl_hierarki
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source("oebs", "segmet_hierarki__test")
        rows:
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-01 00:00:00" }
          - { flex_value: "bar", _oppdatert_tidspunkt: "2020-01-01 00:00:00" }
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-02 00:00:00" }
    expect:
      rows:
        - {
            flex_value: "foo",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: false,
            _hist_last_appered_at: null,
          }
        - {
            flex_value: "bar",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: true,
            _hist_last_appered_at: "2020-01-01 00:00:00",
          }

  - name: hist_oebs__xxrtv_gl_hierarki__full_refresh_restored
    model: hist_oebs__xxrtv_gl_hierarki
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source("oebs", "segmet_hierarki__test")
        rows:
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-01 00:00:00" }
          - { flex_value: "bar", _oppdatert_tidspunkt: "2020-01-01 00:00:00" }
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-02 00:00:00" }
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-03 00:00:00" }
          - { flex_value: "bar", _oppdatert_tidspunkt: "2020-01-03 00:00:00" }
    expect:
      rows:
        - {
            flex_value: "foo",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: false,
            _hist_last_appered_at: null,
          }
        - {
            flex_value: "bar",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: true,
            _hist_last_appered_at: "2020-01-01 00:00:00",
          }
        - {
            flex_value: "bar",
            _hist_valid_from: "2020-01-03 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: false,
            _hist_last_appered_at: null,
          }

  - name: hist_oebs__xxrtv_gl_hierarki__full_refresh_deleted_after_n_days_and_restored
    model: hist_oebs__xxrtv_gl_hierarki
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source("oebs", "segmet_hierarki__test")
        rows:
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-01 00:00:00" }
          - { flex_value: "bar", _oppdatert_tidspunkt: "2020-01-01 00:00:00" }
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-02 00:00:00" }
          - { flex_value: "bar", _oppdatert_tidspunkt: "2020-01-02 00:00:00" }
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-03 00:00:00" }
          - { flex_value: "foo", _oppdatert_tidspunkt: "2020-01-04 00:00:00" }
          - { flex_value: "bar", _oppdatert_tidspunkt: "2020-01-04 00:00:00" }
    expect:
      rows:
        - {
            flex_value: "foo",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: false,
            _hist_last_appered_at: null,
          }
        - {
            flex_value: "bar",
            _hist_valid_from: "2020-01-01 00:00:00",
            _hist_valid_to: null, # or maybe "2020-01-02 00:00:00",
            _hist_is_deleted: true,
            _hist_last_appered_at: "2020-01-02 00:00:00",
          }
        - {
            flex_value: "bar",
            _hist_valid_from: "2020-01-04 00:00:00",
            _hist_valid_to: null,
            _hist_is_deleted: false,
            _hist_last_appered_at: null,
          }
#  - name: my_incremental_model_incremental_mode
#    model: my_incremental_model
#    overrides:
#      macros:
#        # unit test this model in "incremental" mode
#        is_incremental: true
#    given:
#      - input: ref('events')
#        rows:
#          - {event_id: 1, event_time: 2020-01-01}
#          - {event_id: 2, event_time: 2020-01-02}
#          - {event_id: 3, event_time: 2020-01-03}
#      - input: this
#        # contents of current my_incremental_model
#        rows:
#          - {event_id: 1, event_time: 2020-01-01}
#    expect:
#      # what will be inserted/merged into my_incremental_model
#      rows:
#        - {event_id: 2, event_time: 2020-01-02}
#        - {event_id: 3, event_time: 2020-01-03}
